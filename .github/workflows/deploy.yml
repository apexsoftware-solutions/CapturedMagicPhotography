name: Build & Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout (disable default creds - we're using DEPLOY_TOKEN)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2) Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3) Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: client
        run: npm ci

      # 4) Build frontend
      - name: Build frontend
        working-directory: client
        run: npm run build

      # 5) Inject SMTP environment variables into your build (so frontend can use them)
      - name: Configure SMTP secrets
        run: |
          echo "VITE_SMTP_HOST=${{ secrets.SMTP_HOST }}" >> $GITHUB_ENV
          echo "VITE_SMTP_PORT=${{ secrets.SMTP_PORT }}" >> $GITHUB_ENV
          echo "VITE_SMTP_USER=${{ secrets.SMTP_USER }}" >> $GITHUB_ENV
          echo "VITE_SMTP_PASS=${{ secrets.SMTP_PASS }}" >> $GITHUB_ENV
          echo "VITE_SMTP_TO=${{ secrets.SMTP_TO }}" >> $GITHUB_ENV
          echo "VITE_SMTP_FROM=${{ secrets.SMTP_FROM }}" >> $GITHUB_ENV

      # 6) Inspect build output (debug)
      - name: Inspect build output (debug)
        run: |
          echo "=== repo root contents ==="
          ls -la
          echo "=== dist contents ==="
          ls -la dist || true
          echo "=== dist/public contents ==="
          ls -la dist/public || true
          echo "=== client/dist contents ==="
          ls -la client/dist || true

      # 7) Deploy to Hostinger repo - publish dist/public
      - name: Deploy to Hostinger repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.DEPLOY_TOKEN }}
          external_repository: apexsoftware-solutions/CapturedMagicDeploy
          publish_branch: main
          publish_dir: dist/public
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          commit_message: "Deploy: ${{ github.sha }}"
